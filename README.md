# Ethereum Smart Contract project for UAE Blockchain Hackathon

The project uses smart contracts written in [Solidity](http://solidity.readthedocs.io/en/develop/).
The prerequisites to run this project:
- [Truffle](http://truffleframework.com/docs/) - development environment, testing framework, and asset pipeline for Ethereum,
- [testrpc](https://github.com/ethereumjs/testrpc) - a Node.js based Ethereum client for testing and development,
- [geth](https://github.com/ethereum/go-ethereum) - official golang implementation of the Ethereum protocol.

## Smart contract compilation

```shell
truffle compile
```

## Local installation
To install to local testrpc network:

Start testrpc node:

```shell
testrpc
```

Deploy smart contracts

```shell
truffle migrate
```

## Installation on testnet (Ropsten network)
Start local Ropsten node (we use [geth](https://github.com/ethereum/go-ethereum)):

```shell
geth --testnet
```

Unlock your account in geth console

```shell
personal.unlockAccount("0x....")
```

Configure truffle to use testnet node:

in truffle.js:

```json
networks: {
    "ropsten": {
        network_id: 3,
        host: "localhost",
        port: 8545
    }
}
```

Deploy smart constracts:

```shell
truffle migrate --network ropsten
```

## Smart contract API
MyConsents smart contract logs two kinds of events:
- ```LogGiveConsent```
- ```LogWithdrawConsent```

```LogGiveConsent``` is used to store data about given consent in blockchain. Anyone can read data from blockchain and prove that consent was given.

The consent is comprised of:
- the personal data subject (the person, who gives the consent), it is the account which initiates call to giveConsent method;
- ethereum account address of Data controller (Organization) involved in personal data processing,
- identifier of consent type, refers to consent catalogue,
- identifier of personal data attributes set,
- hash of personal data atributes values related to set of attributes.

The ```giveConsent``` function logs an event referring the consent data:

```solidity
function giveConsent(address _dataController, bytes32 _consentId, bytes32 _personalDataSetId, bytes32 _personalDataHash);
```

```LogWithdrawConsent``` is used to store information about the consent withdrawal. Anyone can read data from blockchain and prove that consent was withdrawn.

The ```withdrawConsent``` function logs an event referring to the consent event transaction. It depicts the fact of withdrawing the consent:

```solidity
function withdrawConsent(bytes32 _giveConsentTxHash);
```
It is the blockchain-reading system responsibility to check whether the ```LogWithdrawConsent``` was generated by the personal data subject (and if it is genuine).

### MyConsents JSON API

```JSON
[{"constant":false,"inputs":[{"name":"_dataController","type":"address"},{"name":"_consentId","type":"bytes32"},{"name":"_personalDataSetId","type":"bytes32"},{"name":"_personalDataHash","type":"bytes32"}],"name":"giveConsent","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[],"name":"kill","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_giveConsentTxHash","type":"bytes32"}],"name":"withdrawConsent","outputs":[],"payable":false,"type":"function"},{"inputs":[],"payable":false,"type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"name":"_personalDataSubject","type":"address"},{"indexed":true,"name":"_dataController","type":"address"},{"indexed":true,"name":"_consentId","type":"bytes32"},{"indexed":false,"name":"_personalDataSetId","type":"bytes32"},{"indexed":false,"name":"_personalDataHash","type":"bytes32"}],"name":"LogGiveConsent","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"_personalDataSubject","type":"address"},{"indexed":true,"name":"_giveConsentTxHash","type":"bytes32"}],"name":"LogWithdrawConsent","type":"event"}]
```

### Smart contract call example
Example - how to call smart contract function using geth:

Current MyConsents smart contract address in Ropsten network: ```0x81c61E259f43d433401C7A7268d5472d4382800D```

```
geth attach <path to geth.ipc>
```
in geth console:
```javascript
personal.unlockAccount("<your account address")
var myConsents = eth.contract().at("<smart contract address>")
myConsents.giveConsent(<data controller account address>, <consent type id>, <personal data set id, <personal data hash>);
```

## To improve
- store consent info in blockchain to be able to block withdrawals not originated from personal data subject
- create consent manager smart contract, consents from single data subjects should be stored by dedicated smart contract. Logs should be written by one smart contract (to enable easy search in blockchain transactions)
